<?xml version="1.0" encoding="utf-8" ?>
<!--
  Página: matrizPermisosPage.xaml
  Descripción: UI para administrar la matriz de permisos por Rol.
  ViewModel esperado: MatrizPermisosViewModel
  Propiedades/comandos usados: Roles, RolSeleccionado, Filtro, IsBusy, Estado,
                              PermisosFiltrados, RefrescarCommand, GuardarCommand,
                              RevertirCambiosCommand, MarcarColumnaCommand,
                              LimpiarTodoCommand, MarcarFilaCommand, LimpiarFilaCommand.
-->
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="CONATRADEC.Views.matrizPermisosPage"
             Shell.NavBarIsVisible="False"
             Title="Matriz de permisos"
             BackgroundColor="{OnPlatform WinUI='Transparent', Default={StaticResource color_Blanco}}">

    <!-- Contenedor con plantilla de pie de página común -->
    <ContentView x:Name="MatrizPermisosPage"
                 ControlTemplate="{StaticResource FooterTemplate}">

        <!-- Scroll sólo vertical para listas largas -->
        <ScrollView Orientation="Vertical">

            <VerticalStackLayout>

                <!-- Indicador de carga: se muestra cuando IsBusy = true -->
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                   IsVisible="{Binding IsBusy}"
                                   Color="{StaticResource color_Naranja}"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center" />

                <!-- CUERPO PRINCIPAL -->
                <Grid Padding="20,10,20,0"
                      RowSpacing="10"
                      RowDefinitions="Auto,Auto,Auto,*,Auto,Auto">

                    <!-- TÍTULO -->
                    <Label Text="Permisos"
                           FontSize="30"
                           FontFamily="MontserratBold"
                           TextColor="{StaticResource color_Negro}"
                           FontAttributes="Bold"
                           VerticalOptions="Center"
                           HorizontalOptions="Start" />

                    <!-- FILA 1: Selector de Rol + botón Refrescar -->
                    <Grid Grid.Row="1"
                          ColumnDefinitions="*,Auto"
                          ColumnSpacing="10">

                        <!-- Picker de Roles. Muestra NombreRol y actualiza RolSeleccionado -->
                        <Picker Title="Seleccione un rol"
                                TextColor="{StaticResource color_Negro}"
                                ItemsSource="{Binding Roles}"
                                ItemDisplayBinding="{Binding NombreRol}"
                                SelectedItem="{Binding RolSeleccionado}" />

                        <!-- Botón para recargar lista de Roles -->
                        <Button Grid.Column="1"
                                Style="{StaticResource UpdateButton}"
                                Margin="{OnPlatform WinUI='0,30,0,0', Default='0,0,0,0'}"
                                Text="Refrescar"
                                Command="{Binding RefrescarCommand}"
                                IsEnabled="{Binding !IsBusy}"
                                HeightRequest="{OnPlatform Android=30, iOS=30}"
                                WidthRequest="{OnPlatform Android=90, iOS=90}"
                                FontSize="12" />
                    </Grid>

                    <!-- FILA 2: Cuadro de búsqueda de interfaces -->
                    <!-- Filtra por NombrePermiso en PermisosFiltrados -->
                    <SearchBar Grid.Row="2"
                               TextColor="{StaticResource color_Negro}"
                               Placeholder="Buscar interfaz..."
                               Text="{Binding Filtro}"
                               IsEnabled="{Binding !IsBusy}" />

                    <!-- FILA 3: Encabezado de columnas + acciones por columna -->
                    <VerticalStackLayout Grid.Row="3"
                                         Spacing="8">

                        <!-- Encabezado compacto: Interfaz + botones por columna (L/A/U/E) + limpiar todo -->
                        <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto,Auto"
                              Padding="0,6"
                              ColumnSpacing="2">

                            <!-- Título de la primera columna -->
                            <Label Text="Interfaz"
                                   TextColor="{StaticResource color_Negro}"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center" />

                            <!-- Botón marcar columna Leer -->
                            <Button Grid.Column="1"
                                    Text="L"
                                    FontSize="12"
                                    Padding="8,4"
                                    Command="{Binding MarcarColumnaCommand}"
                                    CommandParameter="leer"
                                    Style="{StaticResource RefreshButton}" />

                            <!-- Botón marcar columna Agregar -->
                            <Button Grid.Column="2"
                                    Text="A"
                                    FontSize="12"
                                    Padding="8,4"
                                    Command="{Binding MarcarColumnaCommand}"
                                    CommandParameter="agregar"
                                    Style="{StaticResource AddButton}" />

                            <!-- Botón marcar columna Actualizar -->
                            <Button Grid.Column="3"
                                    Text="U"
                                    FontSize="12"
                                    Padding="8,4"
                                    Command="{Binding MarcarColumnaCommand}"
                                    CommandParameter="actualizar"
                                    Style="{StaticResource UpdateButton}" />

                            <!-- Botón marcar columna Eliminar -->
                            <Button Grid.Column="4"
                                    Text="E"
                                    FontSize="12"
                                    Padding="8,4"
                                    Command="{Binding MarcarColumnaCommand}"
                                    CommandParameter="eliminar"
                                    Style="{StaticResource DeleteButton}" />

                            <!-- Botón para limpiar todos los checks de todas las filas -->
                            <Button Grid.Column="5"
                                    Text="Limpiar todo"
                                    FontSize="12"
                                    Padding="8,4"
                                    Command="{Binding LimpiarTodoCommand}"
                                    Style="{StaticResource CancelButton}" />
                        </Grid>

                        <!-- LISTA DE PERMISOS (versión sin matriz, expandible por ítem) -->
                        <CollectionView x:Name="PermisosList"
                                        ItemsSource="{Binding PermisosFiltrados}"
                                        SelectionMode="None">

                            <CollectionView.ItemTemplate>
                                <DataTemplate>

                                    <!-- Un ítem representa una InterfazResponse -->
                                    <Grid>

                                        <!-- Expander del CommunityToolkit para ver/ocultar detalle -->
                                        <toolkit:Expander IsExpanded="False">

                                            <!-- CABECERA DEL EXPANDER (estado colapsado) -->
                                            <toolkit:Expander.Header>
                                                <Grid RowDefinitions="*"
                                                      ColumnDefinitions="*,Auto"
                                                      Padding="0,8">
                                                    <!-- Nombre de la interfaz -->
                                                    <Label Text="{Binding NombrePermiso}"
                                                           TextColor="{StaticResource color_Negro}"
                                                           LineBreakMode="TailTruncation"
                                                           VerticalTextAlignment="Start" />

                                                    <!-- Resumen rápido de flags (L/A/U/E) a la derecha -->
                                                    <Label Grid.Column="1"
                                                           FontSize="12"
                                                           Opacity="0.7"
                                                           VerticalTextAlignment="Center">
                                                        <Label.FormattedText>
                                                            <FormattedString>
                                                                <Span Text="L: " TextColor="{StaticResource color_Negro}"/>                                                                
                                                                <Span Text="{Binding Leer}" TextColor="{StaticResource color_Negro}" />
                                                                <Span Text=" | " TextColor="{StaticResource color_Negro}"/>
                                                                <Span Text="  A: " TextColor="{StaticResource color_Negro}"/>
                                                                <Span Text="{Binding Agregar}" TextColor="{StaticResource color_Negro}"/>
                                                                <Span Text=" | " TextColor="{StaticResource color_Negro}"/>
                                                                <Span Text="  Ac: " TextColor="{StaticResource color_Negro}"/>
                                                                <Span Text="{Binding Actualizar}" TextColor="{StaticResource color_Negro}"/>
                                                                <Span Text=" | " TextColor="{StaticResource color_Negro}"/>
                                                                <Span Text="  E: " TextColor="{StaticResource color_Negro}"/>
                                                                <Span Text="{Binding Eliminar}" TextColor="{StaticResource color_Negro}"/>
                                                            </FormattedString>
                                                        </Label.FormattedText>
                                                    </Label>
                                                </Grid>
                                            </toolkit:Expander.Header>

                                            <!-- CONTENIDO DEL EXPANDER (detalle abierto) -->
                                            <toolkit:Expander.Content>

                                                <!-- Contenedor del detalle con separación -->
                                                <Grid ColumnDefinitions="*"
                                                      RowDefinitions="*,*"
                                                      RowSpacing="15">

                                                    <!-- Fila de opciones (etiqueta + checkbox por permiso) -->
                                                    <Grid RowDefinitions="Auto,Auto"
                                                          ColumnDefinitions="*,*,*,*,Auto"
                                                          ColumnSpacing="5"
                                                          >

                                                        <!-- Leer -->
                                                        <Label Grid.Row="0"
                                                               Grid.Column="0"
                                                               Text="Leer"
                                                               TextColor="{StaticResource color_Negro}"
                                                               LineBreakMode="TailTruncation"
                                                               MaxLines="1" />
                                                        <CheckBox Grid.Row="1"
                                                                  Grid.Column="0"
                                                                  IsChecked="{Binding Leer}"
                                                                  Color="{StaticResource BlueUpdate}"
                                                                  HorizontalOptions="Start" />

                                                        <!-- Agregar -->
                                                        <Label Grid.Row="0"
                                                               Grid.Column="1"
                                                               Text="Agregar"
                                                               TextColor="{StaticResource color_Negro}"
                                                               LineBreakMode="TailTruncation"
                                                               MaxLines="1" />
                                                        <CheckBox Grid.Row="1"
                                                                  Grid.Column="1"
                                                                  IsChecked="{Binding Agregar}"
                                                                  Color="{StaticResource BlueUpdate}"
                                                                  HorizontalOptions="Start" />

                                                        <!-- Actualizar -->
                                                        <Label Grid.Row="0"
                                                               Grid.Column="2"
                                                               Text="Actualizar"
                                                               TextColor="{StaticResource color_Negro}"
                                                               LineBreakMode="TailTruncation"
                                                               MaxLines="1" />
                                                        <CheckBox Grid.Row="1"
                                                                  Grid.Column="2"
                                                                  IsChecked="{Binding Actualizar}"
                                                                  Color="{StaticResource BlueUpdate}"
                                                                  HorizontalOptions="Start" />

                                                        <!-- Eliminar -->
                                                        <Label Grid.Row="0"
                                                               Grid.Column="3"
                                                               Text="Eliminar"
                                                               TextColor="{StaticResource color_Negro}"
                                                               LineBreakMode="TailTruncation"
                                                               MaxLines="1" />
                                                        <CheckBox Grid.Row="1"
                                                                  Grid.Column="3"
                                                                  IsChecked="{Binding Eliminar}"
                                                                  Color="{StaticResource BlueUpdate}"
                                                                  HorizontalOptions="Start" />

                                                        <!-- Acciones por fila: marcar todo / ninguno -->
                                                        <Grid Grid.Row="0"
                                                              Grid.RowSpan="2"
                                                              Grid.Column="4"
                                                              ColumnDefinitions="Auto,Auto"
                                                              ColumnSpacing="10">

                                                            <!-- Marca todas las flags de la fila -->
                                                            <Button Grid.Column="0"
                                                                    Text="Todo"
                                                                    Style="{StaticResource AddButton}"
                                                                    CornerRadius="10"
                                                                    HeightRequest="40"
                                                                    Command="{Binding Source={x:Reference PermisosList}, Path=BindingContext.MarcarFilaCommand}"
                                                                    CommandParameter="{Binding .}" />

                                                            <!-- Limpia todas las flags de la fila -->
                                                            <Button Grid.Column="1"
                                                                    Text="Ning."
                                                                    Style="{StaticResource CancelButton}"
                                                                    CornerRadius="10"
                                                                    HeightRequest="40"
                                                                    Command="{Binding Source={x:Reference PermisosList}, Path=BindingContext.LimpiarFilaCommand}"
                                                                    CommandParameter="{Binding .}" />
                                                        </Grid>
                                                    </Grid>

                                                    <!-- Separador visual inferior -->
                                                    <Label Grid.Row="1"
                                                           HeightRequest="5"
                                                           Background="{StaticResource Color_Refrescar_Normal}" />
                                                </Grid>
                                            </toolkit:Expander.Content>

                                        </toolkit:Expander>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- FILA 4: Barra inferior con acciones globales -->
                    <Grid Grid.Row="4"
                          ColumnDefinitions="Auto,*,Auto"
                          ColumnSpacing="10"
                          Padding="0,6">

                        <!-- Revertir cambios no guardados -->
                        <Button Text="Revertir"
                                HeightRequest="40"
                                Style="{StaticResource CancelButton}"
                                Command="{Binding RevertirCambiosCommand}" />

                        <!-- Mensaje de estado (p. ej., "Permisos guardados", "Hay cambios sin guardar") -->
                        <Label Grid.Column="1"
                               Text="{Binding Estado}"
                               VerticalTextAlignment="Center"
                               Opacity="0.7" />

                        <!-- Guardar permisos -->
                        <Button Grid.Column="2"
                                HeightRequest="40"  
                                Text="Guardar"
                                Style="{StaticResource AddButton}"
                                Command="{Binding GuardarCommand}" />
                    </Grid>
                </Grid>
            </VerticalStackLayout>
        </ScrollView>
    </ContentView>
</ContentPage>
